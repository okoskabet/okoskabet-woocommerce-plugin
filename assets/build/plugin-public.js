(()=>{"use strict";const e="oko-shed-custom-div",t=`#${e}`,o="oko-local-custom-div",n=`#${o}`,s='input[name="shipping_method[0]"]:checked',i="#billing_postcode",a="#billing_okoskabet_shed_id",d="locationsDropdown",l=`#${d}`,c="deliveryDatesDropdown",r=`#${c}`,p="oko-shed-content-location",h=`#${p}`,u="oko-shed-content-date",v=`#${u}`,m="oko-map-marker-popup",g=`#${m}`,y="okoIconSelected",k=e=>`\n  <div id="oko-descrption" style="margin-bottom: 20px;">\n    ${e}\n  </div>\n`,w=(e,t)=>e.map((e=>`\n      <option value="${e}">\n        ${t(e)}\n      </option>\n    `)).join(""),D=(e,t)=>`\n  <div class="oko-select-headline" style="font-size: 14px;">\n    Leveringsdato\n  </div>\n  <select name="okoDeliveryDates" id="${c}" style="width: 100%; margin-bottom: 20px;">\n    ${w(e,t)}\n  </select>\n`;class b{constructor(e,t,o){this.locale=e,this.displayOption=t,this.homeDeliveryDescription=o.homeDelivery,this.shedDeliveryDescription=o.shedDelivery,this.attachEventListeners()}attachEventListeners(){const e=jQuery,o=this;e(document).on("change",i,(function(){e(this).val()&&e("body").trigger("update_checkout")})),e(document).on("change",l,(function(){const t=e(this).val();o.changeLocation(t),o.activePopup&&o.activePopup.remove()})),e(document).on("change",r,(function(){const t=e(this).val(),n=o.formatDateToShopLocale(t);o.setDeliveryDateInput(t),e(v).html((e=>`\n  <span class="oko-shed-content-label">Levering: </span>\n  <span class="oko-shed-content-value">${e}</span>\n`)(n))})),e(document).on("click",".okoButtonModalDone",(function(o){o.preventDefault(),e(t).hide()})),e(document).on("click",".okoButtonModalOpen",(function(n){n.preventDefault(),e(t).show(),o.currentMap&&o.currentMap.resize()})),e(document).on("updated_checkout",(function(){o.setDeliveryDateInput(""),e(a).val(""),e(t).remove(),e(n).remove(),e(i).val()&&o.populateShippingOptions()}))}formatDateToShopLocale(e){const t=this.locale.replace("_","-"),o=new Date(e).toLocaleDateString(t,{year:"numeric",month:"long",day:"numeric",weekday:"long",timeZone:"UTC"});return o.charAt(0).toUpperCase()+o.slice(1)}changeLocation(e){const t=jQuery;if("shed-delivery"==this.lastApiResponse?.type){const o=this.lastApiResponse.sheds.find((t=>t.id===e));t(a).val(e),t(h).html(`\n  <span class="oko-shed-content-label">Økoskab: </span>\n  <span class="oko-shed-content-value">${o.name}</span>\n`),this.deselectMarkers();const n=document.getElementById(`marker-${e}`);this.selectMarker(n),t(r).html(w(o.delivery_dates,(e=>this.formatDateToShopLocale(e)))),t(r).trigger("change")}}initMaps({origin:e,sheds:t},o,n){const s=jQuery,i=new window.mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:e?[e.longitude,e.latitude]:[t[0].address.longitude,t[0].address.latitude],zoom:11}),a=new window.mapboxgl.LngLatBounds,d=s(l).find("option:selected").val();if(t.forEach((e=>{const t={lng:e.address.longitude,lat:e.address.latitude},s=this.markerIcon(e,d,o),l=new window.mapboxgl.Popup({offset:20,closeButton:!1}).setHTML((e=>`\n  <div id="${m}" data-shed="${e.id}">\n    <h6 style='font-weight: bold; margin-bottom: 0;'>${e.name}</h6>\n    <div>${e.address.address}</div>\n    <div>${e.address.postal_code} ${e.address.city}</div>\n  </div>\n`)(e)).on("open",n);new window.mapboxgl.Marker(s).setLngLat(t).setPopup(l).addTo(i),a.extend(t)})),e&&e.longitude&&e.latitude){const t={lng:e.longitude,lat:e.latitude};(new window.mapboxgl.Marker).setLngLat(t).addTo(i),a.extend(t)}i.fitBounds(a),this.currentMap=i}markerIcon(e,t,o){const n=document.createElement("div");return n.id=`marker-${e.id}`,n.classList.add("marker"),e.id===t&&n.classList.add(y),n.addEventListener("click",o),n}async callApi(e,t,o,n){const s=[t,o].filter((e=>e&&""!==e)).join(", "),i=new URLSearchParams({zip:n,address:encodeURIComponent(s)}).toString(),a=new Headers;a.append("Accept","application/json"),a.append("Content-Type","application/json");const d={method:"GET",headers:a,redirect:"follow"};let l;switch(e){case"shed-delivery":l="/wp-json/wp/v2/okoskabet/sheds?"+i;break;case"home-delivery":l="/wp-json/wp/v2/okoskabet/home_delivery?"+i}const c=await fetch(l,d),{results:r}=await c.json();return{...r,type:e}}getFormData(){let e;e="hey_okoskabet_shipping_home"===document.querySelector(s).value?"home-delivery":"shed-delivery";const t=document.querySelector(i).value;return{selectedShippingMethod:e,address1:document.querySelector("#billing_address_1").value,address2:document.querySelector("#billing_address_2").value,postalCode:t}}async populateShippingOptions(){const e=jQuery,{selectedShippingMethod:t,address1:o,address2:n,postalCode:i}=this.getFormData(),a=await this.callApi(t,o,n,i),d=e(s).parent();switch(a.type){case"shed-delivery":this.populateShedDeliveryOptions(a,d);break;case"home-delivery":this.populateHomeDeliveryOptions(a,d)}this.lastApiResponse=a,e(l).trigger("change"),e(r).trigger("change")}populateShedDeliveryOptions(t,o){var n;"modal"===this.displayOption&&o.append((n=this.shedDeliveryDescription,`\n  <div id="oko-shed-custom-div-modal">\n    ${k(n)}\n    <div id="oko-shed-content">\n      <div id="${p}"></div>\n      <div id="${u}"></div>\n    </div>\n    <a href="#" class="button okoButtonModalOpen" style="margin-bottom: 20px;">\n      Vælg Økoskab\n    </a>\n  </div>\n`)),o.append(((t,o,n)=>`\n  <div id="${e}">\n    ${k(n)}\n    <div class="oko-select-headline" style="font-size: 14px;">\n      Økoskab\n    </div>\n    <select name="okoLocations" id="${d}" style="width: 100%; margin-top: 0; margin-bottom: 20px;">\n      ${t.map((e=>`\n        <option value="${e.id}">\n          ${e.name}\n        </option>\n      `)).join("")}\n    </select>\n    ${D(t[0].delivery_dates,o)}\n    <div id="map" style="width: 100%; height: 450px; margin-bottom: 20px;">\n    </div>\n    <div class="okoButtonModal okoButtonModalDone">\n      <div class="okoButtonModalContent">\n      </div>\n      <a href="#" class="button">Done</a>\n    </div>\n  </div>\n`)(t.sheds,(e=>this.formatDateToShopLocale(e)),this.shedDeliveryDescription));const s=this;this.initMaps(t,(e=>{this.deselectMarkers(),e.target&&e.target instanceof Element&&this.selectMarker(e.target)}),(function(){const e=this.getElement().querySelector(g);if(e&&e instanceof HTMLElement){const t=e.dataset.shed;s.setLocationInput(t),s.changeLocation(t),s.activePopup=this}}))}populateHomeDeliveryOptions({delivery_dates:e},t){const n=((e,t,n)=>`\n  <div id="${o}">\n    ${k(n)}\n    ${D(e,t)}\n  </div>\n`)(e,(e=>this.formatDateToShopLocale(e)),this.homeDeliveryDescription);t.append(n)}setDeliveryDateInput(e){jQuery("#billing_okoskabet_delivery_date").val(e)}setLocationInput(e){jQuery(l).val(e)}selectMarker(e){e.classList.add(y)}deselectMarkers(){for(const e of document.getElementsByClassName(y))e.classList.remove(y)}}window.onload=()=>{window.mapboxgl.accessToken="pk.eyJ1IjoiZGFub2tvc2thYmV0IiwiYSI6ImNsOTN5enc5eDF0OXgzcW10ejgyMDI3ZHIifQ.Yy_h5jy-F0E2t0EvnElFag",jQuery((function(){const{locale:e,displayOption:t,descriptions:o}=window._okoskabet_checkout;new b(e,t,o)}))}})();